rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated supervisor
    function isSupervisor() {
      return request.auth != null && 
             request.auth.token.email == request.resource.data.supervisorEmail;
    }
    
    // Helper function to check authentication
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Schedules collection
    match /schedules/{scheduleId} {
      // Allow read if:
      // - Schedule is published (anyone can view)
      // - User is authenticated supervisor (can see drafts)
      allow read: if resource.data.status == 'published' || 
                     (isAuthenticated() && request.auth.token.email in resource.data.allowedEmails);
      
      // Only supervisor can create/update/delete schedules
      allow create, update, delete: if isAuthenticated() && 
                                       request.auth.token.email == 'supervisor@clinical.com';
    }
    
    // Employees collection
    match /employees/{employeeId} {
      // Only supervisor can read/write employee data
      allow read, write: if isAuthenticated() && 
                           request.auth.token.email == 'supervisor@clinical.com';
    }
    
    // Entities collection  
    match /entities/{entityId} {
      // Only supervisor can read/write entity data
      allow read, write: if isAuthenticated() && 
                           request.auth.token.email == 'supervisor@clinical.com';
    }
    
    // Settings collection
    match /settings/{setting} {
      // Only supervisor can read/write settings
      allow read, write: if isAuthenticated() && 
                           request.auth.token.email == 'supervisor@clinical.com';
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
